#!/usr/bin/env ruby

require 'cool.io'
require 'yajl'

class TwitterClient < Cool.io::HttpClient
  def self.connect
    super 'stream.twitter.com', 80
  end

  def request
    super 'GET', '/1/statuses/sample.json', :head=>{ 'Authorization'=>"Basic #{ENV['B64_TWITTER_CREDS']}", 'Accept'=>'*/*', 'Connection'=>'keep-alive'}
  end

  def on_connect
    super
    $stderr.puts "connected"
  end

  def on_response_header(header)
    super
    $stderr.puts "response #{header.http_version} #{header.status} #{header.http_reason}"
    $stderr.puts header.inspect
    @yajl = Yajl::Parser.new(:symbolize_keys=>true)
    @yajl.on_parse_complete = method(:on_tweet)
    $stderr.puts "yajl started"
  end

  def on_body_data(data)
    super
    @yajl << data
  end

  def on_error(reason)
    super
    $stderr.puts reason
  end

  def on_request_complete
    super
    $stderr.puts "all done"
  end

  def on_tweet(tweet)
    $stderr.puts tweet.inspect
  end
end

loop = Cool.io::Loop.default
client = TwitterClient.connect.attach(loop)
client.request
loop.run
